+++
title = "How to Set Up Client SSL Certificate Authentication for Rocket.Chat"
date = 2023-05-23T00:00:00Z
layout = "post"
publish = true
comments = false
tags = []

+++

# How to Set Up Client SSL Certificate Authentication for [Rocket.Chat](http://Rocket.Chat) with Nginx

Are you looking to add an extra layer of security to access Rocket.Chat? One way to do this is by implementing client SSL certificate authentication with Nginx. This authentication method requires clients to present a valid SSL certificate to authenticate themselves to the server.

In this tutorial, we will walk through the steps to set up client SSL certificate authentication with Nginx. We assume you have an AWS instance running Ubuntu and have already installed Docker.

## Prerequisites

1. A server
    1. Allow HTTP/HTTPS/ssh in security group
    2. Create a public IP and associate it.
2. A domain
3. **Domain pointed to the server**

## Step 1: Install Nginx

`sudo apt install -y nginx`

## Step 2: Install Certbot

1. `sudo snap install --classic certbot`
2. `sudo certbot --nginx`
    1. Provide email and the domain set

## Step 3: Generate Certificate Authority (CA) Certificates

1. Generate a key for your CA for the client SSL with: `openssl genrsa -des3 -out ca.key 4096`
2. Generate a certificate for your CA: `openssl req -new -x509 -days 365 -key ca.key -out ca.crt`
    1. Note what you’ve entered for Country, State, Locality, and Organization; you’ll want these to match later when you renew the certificate.
    2. Do not enter a common name (CN) for the certificate.
    3. Email can be omitted.
    4. Note renewing certificate involves running the same command. If you need to remember what options you chose you can run: `openssl x509 -in ca.crt -noout -text`
3. Move CA cert to: `/etc/ssl/private/client-cert-ca.crt`
4. Update Nginx listing adding client cert and location block:

```
ssl_client_certificate /etc/ssl/private/client-cert-ca.crt;
ssl_verify_client optional;

location / {
   if ($ssl_client_verify != SUCCESS) {
     return 403;
   }

    proxy_pass <http://localhost:3000/>;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Nginx-Proxy true;
    proxy_redirect off;
  }

```

## Step 4: Issue Client SSL Certificates

1. Generate key: `openssl genrsa -des3 -out user.key 4096`
2. Generate CSR: `openssl req -new -key user.key -out user.csr`
    1. A number of questions will be asked; answer each one, including the Common Name (CN) and email address. The CSR needs to be sent to the admin (or you if you are doing this for the user).
3. As the admin, take the CSR given to you or generated by you and sign the CSR and create valid certificate: `openssl x509 -req -days 365 -in user.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out user.crt`
4. You’ll want to increment the serial number with each signing. Once the certificate expires, a new CSR doesn’t need to be recreated; the same one can be signed, which will create a new certificate tied to that public key.
5. The signed certificate would be sent back to the user along with the CA cert (not the key!), for installation on their device.
6. Generate pkcs #12: `openssl pkcs12 -export -out user.pfx -inkey user.key -in user.crt -certfile ca.crt` beware if you intend to install on Mac or iOS, generate on iOS or use an older version of OpenSSL. More info here: [https://developer.apple.com/forums/thread/697030?answerId=710429022#710429022](https://developer.apple.com/forums/thread/697030?answerId=710429022#710429022)

## Step 5: Access Rocket.Chat using Client SSL Certificate

To access your application with client certificate authentication:

On iOS:

- Add the file on Files app (depending on what you do, iOS will try to install it on the whole OS. e.g. copying from airdrop)
- Go to new server screen and try the server URL just to confirm (an error message should show because you haven't applied the cert yet)
- Tap `apply your certificate` on the bottom of the screen and select it from the Files app
- Try again, and it should navigate to the workspace info

On Android:

- Install the certificate
- Go to new server screen and try the server URL just to confirm (an error message should show because you haven't applied the cert yet)
- Tap `apply your certificate`, and the OS should prompt you to select a cert
- Select it
- Tap connect, and it should navigate to the workspace info

To add a client certificate in Firefox:

1. Open Firefox and click on the three horizontal lines in the top-right corner of the window.
2. Select "Preferences".
3. In the left-hand menu, click on "Privacy & Security".
4. Scroll down to the "Certificates" section and click on "View Certificates".
5. Click on the "Your Certificates" tab.
6. Click on "Import".
7. Browse to the location of your client certificate file and select it.
8. Enter the password for the certificate if prompted.
9. Click "OK".
10. Your client certificate should now be imported and ready to use in Firefox.

Congratulations! You have successfully set up client SSL certificate authentication for [Rocket.Chat](http://Rocket.Chat) using Nginx.

Extremely useful Reference: [https://fardog.io/blog/2017/12/30/client-side-certificate-authentication-with-nginx/](https://fardog.io/blog/2017/12/30/client-side-certificate-authentication-with-nginx/)
